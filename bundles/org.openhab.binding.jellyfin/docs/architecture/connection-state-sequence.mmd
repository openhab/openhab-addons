# Connection → CONNECTED → ServerSync / Discovery sequence

%% Connection → CONNECTED → ServerSync / Discovery sequence
sequenceDiagram
autonumber
participant Conn as ConnectionTask
participant Handler as ServerHandler
participant TM as TaskManager
participant WS as WebSocketTask
participant Sync as ServerSyncTask
participant Disc as DiscoveryTask
participant HTTP as Jellyfin /Users
participant UM as UserManager
participant SM as SessionManager
participant CDS as ClientDiscoveryService

%% Connection and state transition
Conn->>+Handler: retrieve SystemInfo
Handler->>Handler: setState(CONNECTED)
Handler->>Handler: set Thing ONLINE
Handler->>TM: processStateChange(CONNECTED)

alt WebSocket available
    TM->>+WS: start WebSocketTask (realtime)
    TM->>+Disc: start DiscoveryTask
else No WebSocket
    TM->>+Sync: start ServerSyncTask (polling)
    TM->>+Disc: start DiscoveryTask
end

loop ServerSync (every 60s)
    Sync->>+SM: refresh sessions
    SM->>SessionAPI: getSessions(null,...)
    SessionAPI-->>SM: List<SessionInfoDto>
    SM->>Handler: updateSessions(sessions)
end

note over Disc: DiscoveryTask run (every 60s)
    Disc->>+HTTP: GET /Users
    HTTP-->>-Disc: List<UserDto>
    Disc->>Handler: usersHandler.accept(users)
    Handler->>UM: processUsersList(users)
    UM-->>Handler: UserChangeResult
    Handler->>Updater: updateClients(apiClient, activeUserIds, clients)
    Updater->>SessionAPI: getSessions(null,...)
    SessionAPI-->>Updater: List<SessionInfoDto>
    Updater->>Updater: Filter by activeUserIds & update clientMap
    Updater-->>Handler: Client map updated
    Handler->>CDS: discoverClients()
end

%% WebSocket fallback path
WS-->>-Handler: connectionFailure
Handler->>Handler: handleWebSocketFallback()
Handler->>TM: processStateChange(CONNECTED)  %% ensures ServerSync started
Handler->>+Sync: start ServerSyncTask (fallback)
