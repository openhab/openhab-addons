// Generated by CoffeeScript 1.9.1
'use strict';
angular.module('ZooLib.directives.masterSwitch', []).directive('masterSwitch', function($log, itemService) {
  return {
    restrict: 'E',
    replace: true,
    templateUrl: 'partials/directives/masterSwitch.html',
    scope: {
      item: '='
    },
    link: function(scope) {
      var updateItemState;
      scope.local = {
        state: null
      };
      updateItemState = function(newState) {
        return scope.local.state = newState;
      };
      scope.handleChange = function() {
        $log.log("MasterSwitch: Fire event " + scope.item.name + " to " + scope.local.state);
        return itemService.sendCommand({
          itemName: scope.item.name
        }, scope.local.state);
      };
      scope.$watch('item', function(item, oldItem) {
        if (item === oldItem) {
          return;
        }
        if (item == null) {
          return;
        }
        updateItemState(item.state);
        scope.$on("smarthome/command/" + item.name, function(event, newState) {
          scope.item.state = newState;
          return updateItemState(newState);
        });
        return scope.$on("updateMasterSwitch/" + item.name, function() {
          return itemService.getByName({
            itemName: scope.item.name
          }, function(item) {
            $log.info("Reloaded new masterSwitch state " + item.name, item);
            return updateItemState(item.state);
          });
        });
      });
    }
  };
});
