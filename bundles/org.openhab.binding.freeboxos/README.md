# Freebox Binding

This binding integrates the [Freebox Revolution](https://www.free.fr/freebox/freebox-revolution/) and [Freebox Delta](https://www.free.fr/freebox/freebox-delta/) to your openHAB installation.

The server can be connected to Free infrastructures either by xDSL or fiber optic.

## Supported Things

This binding supports the following thing types:

| Thing      | Thing Type | Description                                           |
|------------|------------|-------------------------------------------------------|
| api        | Bridge     | Bridge to access freebox OS API hosted by the server. |
| delta      | Thing      | A Freebox Delta server.                               |
| revolution | Thing      | A Freebox Revolution server.                          |
| player     | Thing      | The TV player equipment (e.g. Devialet).              |
| landline   | Thing      | The phone wired to the Freebox Server.                |
| host       | Thing      | A network device on the local network.                |
| wifihost   | Thing      | A wifi networked device on the local network.         |
| vm         | Thing      | A virtual machine hosted on the server (>= Delta).    |
| repeater   | Thing      | A Free wifi repeater.                                 |

## Discovery

The API bridge is discovered automatically through mDNS in the local network.
After the bridge is discovered and available to openHAB, the binding will automatically discover phone, network devices available on the local network.
Note that the discovered thing will be setup to use only HTTP API (and not HTTPS) because only an IP can be automatically determined while a domain name is required to use HTTPS with a valid certificate.

## Binding configuration

FreeboxOs binding has the following configuration parameters:

| Name            | Description                                        | Mandatory |
|-----------------|----------------------------------------------------|-----------|
| timeout         | The timeout for reading from the device in seconds | yes       |


## Thing Configuration

### Api bridge

| Parameter Label          | Parameter ID      | Description                                            | Required | Default              |
|--------------------------|-------------------|--------------------------------------------------------|----------|----------------------|
| Freebox Server Address   | api_domain        | The domain to use in place of hardcoded Freebox ip     | No       | mafreebox.freebox.fr |
| Application Token        | appToken          | Token generated by the Freebox Server.                 | Yes      |                      |
| Network Device Discovery | discoverNetDevice | Enable the discovery of network device things.         | No       | false                |
| HTTPS Available          | https_available   | Tells if https has been configured on the Freebox      | No       | false                |
| HTTPS port               | https_port        | Port to use for remote https access to the Freebox Api | No       | 15682                |

If the parameter *api_domain* is not set, the binding will use the default address used by Free to access your Freebox Server (mafreebox.freebox.fr).
The bridge thing will initialize only if a valid application token (parameter *appToken*) is filled.

### Server : Revolution or Delta

The *revolution* or *delta* thing requires the following configuration parameters:

| Parameter Label  | Parameter ID    | Description                                                              | Required | Default |
|------------------|-----------------|--------------------------------------------------------------------------|----------|---------|
| Refresh Interval | refreshInterval | The refresh interval (seconds) which is used to poll the Freebox Server. | No       | 30      |

### Player thing 

The *player* thing requires the following configuration parameters:

| Parameter Label  | Parameter ID    | Description                                                                | Required | Default |
|------------------|-----------------|----------------------------------------------------------------------------|----------|---------|
| MAC Address      | macAddress      | The MAC address of the player device.                                      | Yes      |         |
| ID               | id              | Id of the player within Freebox Api                                        | Yes      | 1       |
| Player port      | port            |                                                                            | No       | 24322   |            
| Password         | password        | AirPlay password                                                           | No       |         |
| Remote Code      | remoteCode      | Code associated to remote control                                          | No       |         |
| Accept all MP3   | acceptAllMp3    | Accept any bitrate for MP3 audio or only bitrates greater than 64 kbps     | No       | true    |
| Refresh Interval | refreshInterval | The refresh interval in seconds which is used to poll the player           | Yes      | 30      |
| Callback URL     | callbackUrl     | URL to use for playing notification sounds, e.g. 'http://192.168.0.2:8080' | No       |         |

### Landline

The *landline* thing requires the following configuration parameters:

| Parameter Label  | Parameter ID    | Description                                                            | Required | Default |
|------------------|-----------------|------------------------------------------------------------------------|----------|---------|
| Refresh Interval | refreshInterval | The refresh interval in seconds which is used to poll for phone state. | No       | 2       |

### Network devices : Host and WifiHost

The *host* and *wifihost* things requires the following configuration parameters:

| Parameter Label  | Parameter ID    | Description                                                                | Required | Default |
|------------------|-----------------|----------------------------------------------------------------------------|----------|---------|
| MAC Address      | macAddress      | The MAC address of the network host .                                      | Yes      |         |
| Refresh Interval | refreshInterval | The refresh interval in seconds which is used to poll for phone state.     | No       | 30      |

### Repeater and Vm thing 

The *repeater* thing is a specialized case of a *wifihost*. The *vm* derives from *host*. They share the same configuration definition : 

| Parameter Label  | Parameter ID    | Description                                                      | Required | Default |
|------------------|-----------------|------------------------------------------------------------------|----------|---------|
| MAC Address      | macAddress      | The MAC address of the player device.                            | No       |         |
| ID               | id              | Id of the repeater within Freebox Api                            | Yes      | 1       |
| Refresh Interval | refreshInterval | The refresh interval in seconds which is used to poll the player | Yes      | 30      |

## Authentication

You will have to authorize openHAB to connect to your Freebox. Here is the process described :

**Step 1** At binding startup, if no token is recorded in the Freebox Server (bridge) configuration, the binding will run a pairing request

**Step 2** Run to your Freebox and approve the pairing request for openHAB Freebox Binding that is displayed on the Freebox screen

**Step 3** the application token is automatically recorded in the Freebox Server (bridge) configuration

**Step 4** you can use the console command `freeboxos apptoken` to display the application token and use it later to set up your thing in a configuration file

**Optionally** you can log in your Freebox admin console to allocate needed rights to openHAB

Once initialized, the thing will generate all available channels.

## Channels

The following channels are supported:

| Thing         | Channel Type ID      | Item Type | Access Mode | Description                                                                    |
|---------------|----------------------|-----------|-------------|--------------------------------------------------------------------------------|
| revolution    | lcd_brightness       | Number    | RW          | Brightness level of the screen in percent                                      |
| revolution    | lcd_orientation      | Number    | RW          | Screen Orientation in degrees (0 or 90 or 180 or 270)                          |
| revolution    | lcd_forced           | Switch    | RW          | Indicates whether the screen orientation forced                                |
| server (*)    | uptime               | Number    | R           | Time since last reboot of the Freebox Server                                   |
| server (*)    | restarted            | Switch    | R           | Indicates whether the Freebox server has restarted during the last poll period |
| server (*)    | wifi_status          | Switch    | RW          | Indicates whether the WiFi network is enabled                                  |
| server (*)    | ftp_status           | Switch    | RW          | Indicates whether the FTP server is enabled                                    |
| server (*)    | airmedia_status      | Switch    | RW          | Indicates whether Air Media is enabled                                         |
| server (*)    | upnpav_status        | Switch    | RW          | Indicates whether UPnP AV is enabled                                           |
| server (*)    | samba-file-status    | Switch    | RW          | Indicates whether Window File Sharing is enabled                               |
| server (*)    | samba-printer-status | Switch    | RW          | Indicates whether Window Printer Sharing is enabled                            |
| server (*)    | xdsl_status          | String    | R           | Status of the xDSL line                                                        |
| server (*)    | ftth_status          | Switch    | R           | Status of the Ftth line                                                        |
| server (*)    | line_status          | String    | R           | Status of network line connexion                                               |
| server (*)    | ipv4                 | String    | R           | Public IP Address of the Freebox Server                                        |
| server (*)    | rate_up              | Number    | R           | Current upload rate in byte/s                                                  |
| server (*)    | rate_down            | Number    | R           | Current download  rate in byte/s                                               |
| server (*)    | bytes_up             | Number    | R           | Total uploaded bytes since last connection                                     |
| server (*)    | bytes_down           | Number    | R           | Total downloaded  bytes since last connection                                  |
| phone         | state#onhook         | Switch    | R           | Indicates whether the phone is on hook                                         |
| phone         | state#ringing        | Switch    | R           | Is the phone ringing                                                           |
| phone         | accepted#number      | Call      | R           | Last accepted call: number                                                     |
| phone         | accepted#duration    | Number    | R           | Last accepted call: duration in seconds                                        |
| phone         | accepted#timestamp   | DateTime  | R           | Last accepted call: creation timestamp                                         |
| phone         | accepted#name        | String    | R           | Last accepted call: caller name                                                |
| phone         | missed#number        | Call      | R           | Last missed call: number                                                       |
| phone         | missed#timestamp     | DateTime  | R           | Last missed call: creation timestamp                                           |
| phone         | missed#name          | String    | R           | Last missed call: caller name                                                  |
| phone         | outgoing#number      | Call      | R           | Last outgoing call: number                                                     |
| phone         | outgoing#duration    | Number    | R           | Last outgoing call: duration in seconds                                        |
| phone         | outgoing#timestamp   | DateTime  | R           | Last outgoing call: creation timestamp                                         |
| phone         | outgoing#name        | String    | R           | Last outgoing call: called name                                                |
| net_device    | reachable            | Switch    | R           | Indicates whether the network device is reachable                              |
| net_interface | reachable            | Switch    | R           | Indicates whether the network interface is reachable                           |
| airplay       | playurl              | String    | W           | Play an audio or video media from the given URL                                |
| airplay       | stop                 | Switch    | W           | Stop the media playback                                                        |

(*) : server means *delta* or *revolution*

## Actions for ules

The following actions are available in rules/scripting:

| Thing Type  | Action Name      | Description                                          | 
|-------------|------------------|------------------------------------------------------|
| host        | wol              | Sends a wake on lan packet to the lan connected host |
| player      | reboot           | Reboots the player device.                           |
| player      | sendKey          | Send a key (remote emulation) to the player          |
| player      | sendLongKey      | Sends the key emulating a longpress on the button    |
| player      | sendMultipleKeys | Sends multiple keys to the player, comma separated   |
| player      | sendKeyRepeat    | Sends the key multiple times                         |
| server      | reboot           | Reboots the Freebox Server.                          |

