${AUTOGENERATED_WARNING}
package ${packageName};

import org.eclipse.jdt.annotation.Nullable;
import org.openhab.automation.java223.common.BindingInjector;
import org.openhab.automation.java223.common.InjectBinding;
import org.openhab.automation.java223.common.Java223Constants;
import org.openhab.automation.java223.common.RunScript;
import org.openhab.core.automation.RuleManager;
import org.openhab.core.automation.module.script.ScriptExtensionManagerWrapper;
import org.openhab.core.automation.module.script.rulesupport.shared.ScriptedAutomationManager;
import org.openhab.core.automation.module.script.rulesupport.shared.ValueCache;
import org.openhab.core.thing.ThingManager;
import org.openhab.core.types.State;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import helper.rules.RuleAnnotationParser;
import helper.rules.RuleParserException;

${imports}


/**
 * Base helper class for all Java223 Scripts.
 * This class needs the helper-lib.jar
 * Features:
 * - Standard JSR223 OpenHAB bindings already declared as fields for immediate access
 * - Auto execution of a parsing rule method (internalParseRules calling RuleAnnotationParser)
 * - Additional shortcut to useful services (automationManager, sharedCache, ruleManager)
 * - Include other generated helper classes (_items, _actions, _things)
 */
public abstract class Java223Script {

    // warning: default openhab logger level is error
    protected Logger logger = LoggerFactory.getLogger(this.getClass());

    // all OpenHAB input as a convenience object:
    protected @InjectBinding Map<String, Object> bindings;

    // for transformation support
    protected @Nullable String input;

    // default preset
    protected @InjectBinding ScriptExtensionManagerWrapper scriptExtension;
    protected @InjectBinding ScriptExtensionManagerWrapper se;
${fieldsDeclaration}

    // needed for rule support
    protected @InjectBinding(preset = "RuleSupport") ScriptedAutomationManager automationManager;

    // not the default preset, but handy (cache, additional shortcuts to useful OSGi services, generated classes)
    protected @InjectBinding(preset = "cache") ValueCache sharedCache;
    protected @InjectBinding(preset = "cache") ValueCache privateCache;
    protected @InjectBinding RuleManager ruleManager;
    protected @InjectBinding ThingManager thingManager;
    protected @InjectBinding Items _items;
    protected @InjectBinding Actions _actions;
    protected @InjectBinding Things _things;

    /**
     * Parse all method/field rules in this script
     */
    @RunScript
    public void internalParseRules() {
        try {
            RuleAnnotationParser.parse(this, (String) bindings.get(Java223Constants.JAVA_223_IDENTIFIER), automationManager);
        } catch (IllegalArgumentException | RuleParserException e) {
            logger.error("Cannot parse rules", e);
        }
    }

    /** 
     * Use this method to manually inject binding value in an object of your choice.
     * You probably don't need this (you should use your object as a library and let this helper framework inject it)
     */
    public void injectBindings(Object objectToInjectInto) {
        BindingInjector.injectBindingsInto(this.getClass().getClassLoader(), bindings, objectToInjectInto);
    }

    /**
     * Use this method to instantiate one of your libraries with all binding values injected if you can't use auto-injection.
     * This can be especially useful for one-liner script because they can't declare a library as a class member or method parameter.
     * @param clazz
     * @return The instantiated class
     */
    public <T> T createAndInjectBindings(Class<T> clazz) {
        return BindingInjector.getOrInstantiateObject(this.getClass().getClassLoader(), bindings, clazz);
    }

    /**
    * Get any OSGi service in the openHAB runtime
    * @param serviceClass The targeted service class
    * @return Instance of the OSGi service
    */
    public <T> T getService(Class<T> serviceClass) {
        return ((org.openhab.automation.java223.common.ServiceGetter) bindings.get(Java223Constants.SERVICE_GETTER)).getService(serviceClass);
    }
}
